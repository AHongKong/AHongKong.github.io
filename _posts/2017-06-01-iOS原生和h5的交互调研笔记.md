---
layout: post
title:  "iOSåŸç”Ÿå’ŒH5çš„äº¤äº’è°ƒç ”ç¬”è®°"
date:   2017-06-01 13:40:34 +0800
---

#### ç¬¬ä¸€éƒ¨åˆ†åŸç†è§£æ


###### UIWebView

UIWebViewï¼Œè‹¹æœåœ¨iOS2.0æ¨å‡ºã€‚

** UIWebViewä¸JSäº¤äº’åŸç†ï¼š**

	H5ï¼>é€šè®¯åè®®ï¼>åŸç”Ÿ
	
	åŸç”Ÿ->å›è°ƒå‡½æ•°ï¼>H5

** ç†è§£ï¼š**

1. äº¤äº’ä¹‹å‰ï¼Œåˆ¶å®šå¥½H5å’ŒåŸç”Ÿçš„äº¤äº’é€šè®¯åè®®ï¼šç±»ä¼¼äºHttpåè®®ï¼›
2. H5é€šè¿‡è§¦å‘èƒ½è¢«åŸç”Ÿç›‘å¬å¹¶æ•è·æˆªæ‹¦çš„H5è¡Œä¸ºï¼ŒåŸç”Ÿé€šè¿‡Webä»£ç†æ‹¦æˆªï¼Œè·å–é€šè®¯åè®®ï¼Œè§£æåŒ¹é…åä¼šè·¯ç”±åˆ°å…·ä½“å¤„ç†æ–¹æ³•ï¼Œæ‰§è¡ŒåŸç”Ÿèƒ½åŠ›é€»è¾‘,æ¯”å¦‚ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œæˆ–è€…ç•Œé¢è·³è½¬ã€‚
3. åŸç”Ÿåœ¨å¤„ç†å®Œæ•°æ®çš„æ—¶æœºæŠŠæ•°æ®é€šè¿‡APIå›è°ƒä¼ é€’ç»™H5ï¼Œè®©H5åšç›¸åº”çš„å±•ç¤ºã€‚

		èƒ½è¢«åŸç”Ÿç›‘å¬å¹¶æ•è·æˆªæ‹¦çš„H5è¡Œä¸ºï¼š console.logã€alertã€confirmã€promptã€location.href ç­‰ã€‚
	
		ä¸¾ä¾‹ï¼šlocation.href ='jsbridge://method?a=2&b=3#h5MethodTag'
		
		åè®®åï¼šjsbridge://ï¼Œapp è‡ªå®šä¹‰çš„åè®®åï¼Œç”¨äºH5è§¦å‘è¡Œä¸ºçš„ç›‘æ§æ•è·ï¼›
		
		æ¥å£è·¯å¾„ï¼šmethodï¼ŒåŸç”Ÿå…·ä½“èƒ½åŠ›è·¯å¾„ï¼Œä¸åŒåŸç”Ÿèƒ½åŠ›è·¯å¾„ä¸åŒï¼›
		
		å‚æ•°ï¼ša=2&b=3
		
		å›è°ƒï¼šh5MethodTagï¼ŒåŸç”Ÿå›è°ƒH5çš„æ–¹æ³•æ ‡è¯†ï¼›

** ç¬¬ä¸€éƒ¨åˆ†ï¼šH5->åŸç”Ÿ
**

é€šè¿‡shouldStartLoadWithRequestä»£ç†æ–¹æ³•æ‹¦æˆªH5äº‹ä»¶,è§£æåè®®è·¯ç”±åˆ°å…·ä½“æ–¹æ³•ã€‚


	- (BOOL)webView:(UIWebView *)webView shouldStartLoadWithRequest:(NSURLRequest *)request navigationType:(UIWebViewNavigationType)navigationTypeï¼›

** ç¬¬äºŒéƒ¨åˆ†ï¼šåŸç”Ÿ->H5
**

åœ¨webViewDidFinishLoadçš„æ—¶æœºï¼Œé€šè¿‡stringByEvaluatingJavaScriptFromStringå›è°ƒJSå‡½æ•°ï¼Œä¼ é€’ï¼Œæˆ–è€…æ›´æ”¹H5ç•Œé¢å…ƒç´ ã€‚

	- (void)webViewDidFinishLoad:(UIWebView *)webView;//UIWebViewä»£ç†æ–¹æ³•
	- (nullable NSString *)stringByEvaluatingJavaScriptFromString:(NSString *)script;//UIwebViewçš„å®ä¾‹æ–¹æ³•ï¼Œå¯ä»¥è·å–H5ç•Œé¢å…ƒç´ ï¼Œè°ƒç”¨åŸæœ‰çš„JSæ–¹æ³•ï¼Œä¹Ÿå¯æ³¨å…¥æ–°çš„JSä»£ç ï¼Œè°ƒç”¨æ–°æ³¨å…¥çš„ä»£ç 

å…³äºå¦‚ä½•è§£è—•H5ï¼Œå®ç°æ›´å¥½çš„è·¨å¹³å°ï¼ŒæŸ¥é˜…æ–‡ç« 
[è§£è€¦---Hybrid H5è·¨å¹³å°æ€§æ€è€ƒ](https://mp.weixin.qq.com/s?__biz=MzA3NTYzODYzMg==&mid=2653577297&idx=3&sn=96c9ec407e937132595c29b0584cdd5c&scene=0#wechat_redirect)

###### WKWebView

iOS8ä»¥åï¼Œè‹¹æœæ¨å‡ºäº†æ–°æ¡†æ¶Wekkitï¼Œæä¾›äº†æ›¿æ¢UIWebViewçš„ç»„ä»¶WKWebViewã€‚

** ç¬¬ä¸€éƒ¨åˆ†ï¼šH5->åŸç”Ÿ
**

JavaScriptè°ƒç”¨åŸç”Ÿ

		    window.webkit.messageHandlers.jsCallOC.postMessage(dict);
			    
  
åŸç”Ÿå“åº”è°ƒç”¨ï¼Œéœ€è¦åŸç”Ÿå…ˆé€šè¿‡WKUserContentControlleræ³¨å†Œæ–¹æ³•ã€‚WKUserContentControllerè¿˜æœ‰ä¸€ä¸ªåŠŸèƒ½æ³¨å…¥jsã€‚

    WKUserContentController *userContentController = [[WKUserContentController alloc] init];
    
    [userContentController addScriptMessageHandler:self name:@"jsCallOC"];

åŸç”Ÿéµå¾ªWKScriptMessageHandlerä»£ç†å¤„ç†è·¯ç”±

	#pragma mark - WKScriptMessageHandlerä»£ç†å¤„ç†JSè°ƒç”¨OC
	- (void)userContentController:(WKUserContentController *)userContentController didReceiveScriptMessage:(WKScriptMessage *)message {
	    NSLog(@"æ–¹æ³•å:%@", message.name);
	    NSLog(@"å‚æ•°:%@", message.body);
	        // æ–¹æ³•å
	    NSString *methods = [NSString stringWithFormat:@"%@:", message.name];
	    SEL selector = NSSelectorFromString(methods);
	        // è°ƒç”¨æ–¹æ³•
	    if ([self respondsToSelector:selector]) {
	        [self performSelector:selector withObject:message.body];
	    } else {
	        NSLog(@"æœªå®è¡Œæ–¹æ³•ï¼š%@", methods);
	    }
	
	    
	}
	


** ç¬¬äºŒéƒ¨åˆ†ï¼šåŸç”Ÿ->H5
**

åŸç”Ÿè°ƒç”¨JSï¼ŒjavaScriptStringæ˜¯jsçš„å‡½æ•°åï¼ŒevaluateJavaScriptæ˜¯WKWebViewçš„å®ä¾‹æ–¹æ³•ã€‚

	- (void)evaluateJavaScript:(NSString *)javaScriptString completionHandler:(void (^ _Nullable)(_Nullable id, NSError * _Nullable error))completionHandler;
	
åŸç”Ÿè¿˜æä¾›ç›‘å¬Promptï¼Œalertï¼ŒConfirmçš„ä»£ç†æ–¹æ³•

	- (void)webView:(WKWebView *)webView runJavaScriptTextInputPanelWithPrompt:(NSString *)prompt defaultText:(nullable NSString *)defaultText initiatedByFrame:(WKFrameInfo *)frame completionHandler:(void (^)(NSString * _Nullable result))completionHandler {
	    
	}
	
	- (void)webView:(WKWebView *)webView runJavaScriptConfirmPanelWithMessage:(NSString *)message initiatedByFrame:(WKFrameInfo *)frame completionHandler:(void (^)(BOOL result))completionHandler {
	    
	}
	
	- (void)webView:(WKWebView *)webView runJavaScriptAlertPanelWithMessage:(NSString *)message initiatedByFrame:(WKFrameInfo *)frame completionHandler:(void (^)(void))completionHandler {
	    
	}

___
ä¸Šé¢ä¸¤ä¸ªwebViewçš„å•å•ä»ä¸H5äº¤äº’è¿™ä¸ªè§’åº¦è¿›è¡Œå¯¹æ¯”ï¼Œå¾ˆå¤šåŠŸèƒ½UIWebViewå’ŒWKWebViewéƒ½å¯ä»¥å®ç°ï¼ŒUIWebViewéœ€è¦å¤„ç†æ›´å¤šçš„ç»†èŠ‚ï¼ŒWKWebViewçš„å°è£…æ€§æ›´å¥½ï¼Œè€Œä¸”æä¾›äº†æ›´å¤šçš„æ–¹æ³•å¯ä»¥è°ƒç”¨ã€‚

<font color = "orange">
ä¸Šé¢éƒ½æ˜¯é€šè¿‡iOSåŸç”Ÿæ§ä»¶ç›´æ¥åŠ è½½webç•Œé¢ï¼Œä½¿ç”¨æ§ä»¶çš„åŸç”Ÿæ–¹æ³•å’ŒH5è¿›è¡Œäº¤äº’ï¼Œä¸‹é¢å°†ä½¿ç”¨iOSåŸç”Ÿæ¡†æ¶*JavaScriptCore*æ¡†æ¶ï¼Œå’Œç¬¬ä¸‰æ–¹æ¡†æ¶*WebViewJavascriptBridge*æ¥å®ç°ä¸H5çš„äº¤äº’</font>
___

###### WebViewJavascriptBridge
WebViewJavascriptBridgeæä¾›äº†å¯¹UIWebViewå’ŒWKWebViewä¸¤ä¸ªåŸç”Ÿæ§ä»¶çš„æ”¯æŒã€‚åªéœ€è¦æ ¹æ®æ§ä»¶é€‰æ‹©å¯¹åº”çš„bridgeå³å¯ï¼Œäº¤äº’APIåŸºæœ¬ä¸å˜ã€‚

** ç¬¬ä¸€éƒ¨åˆ†ï¼šH5->åŸç”Ÿ
**
H5é€šè¿‡bridge.callHandler æˆ–è€… bridge.sendè§¦å‘äº‹ä»¶è°ƒç”¨åŸç”Ÿï¼ŒåŸç”Ÿé€šè¿‡ä¸‹é¢ä»£ç ä¸­æ³¨å†Œçš„æ–¹æ³•ï¼Œå“åº”H5çš„è°ƒç”¨ã€‚

    _bridge = [WebViewJavascriptBridge bridgeForWebView:_webView];
    [_bridge registerHandler:@"handleName" handler:^(id data, WVJBResponseCallback responseCallback) {
            //JSè°ƒç”¨åŸç”Ÿï¼ŒåŸç”Ÿå“åº”å¤„ç†é€»è¾‘ã€‚
     }];


**ç¬¬äºŒéƒ¨åˆ†ï¼šåŸç”Ÿ->H5
**

åŸç”Ÿé€šè¿‡ğŸ‘‡ä¸‰ä¸ªæ–¹æ³•è°ƒç”¨JSæ–¹æ³•ï¼ŒhandlerNameå¯ä»¥æ˜¯JSçš„å‡½æ•°åï¼Œdataæ˜¯å‚æ•°

	- (void)callHandler:(NSString*)handlerName;
	- (void)callHandler:(NSString*)handlerName data:(id)data;
	- (void)callHandler:(NSString*)handlerName data:(id)data responseCallback:(WVJBResponseCallback)responseCallback;


###### JavaScriptCore
JavaScriptCoreæ¡†æ¶æ˜¯è‹¹æœåœ¨iOS7.0æ¨å‡ºçš„iOSå’ŒJSäº¤äº’çš„æ–°æ–¹æ¡ˆï¼Œæ›´åŠ é¢å‘å¯¹è±¡ã€‚UIWebViewå’ŒWKWebKitéƒ½å¯ä½¿ç”¨JavaScriptCoreæ¡†æ¶ã€‚æ³¨æ„ï¼Œ** å¬è¯´ **WKWebViewä¸­é‰´äºä¸€äº›çº¿ç¨‹å’Œè¿›ç¨‹çš„é—®é¢˜æœ‰æ— æ³•è·å–JSContextçš„ç°è±¡ã€‚

** ç¬¬ä¸€éƒ¨åˆ†ï¼šH5->åŸç”Ÿ
**

JSè°ƒç”¨åŸç”Ÿçš„æ–¹æ³•

	   <input type="button" value="Call ObjC system camera" onclick="OCModel.callSystemCamera()">
	   <input type="button" value="Call ObjC system alert" onclick="OCModel.showAlertMsg('js title', 'js message')">
	   
 åŸç”Ÿéœ€è¦å®ç°OCModelå¯¹è±¡çš„ç»‘å®š
 
 1. å£°æ˜ä¸€ä¸ªç»§æ‰¿JSExportåè®®çš„åè®®JavaScriptObjectiveCDelegateï¼Œå¹¶ä¸”å£°æ˜è®©JSè°ƒç”¨çš„æ–¹æ³•
 2. åˆ›å»ºä¸€ä¸ªç±»éµå¾ªJavaScriptObjectiveCDelegateåè®®çš„å¯¹è±¡

	@interface NLJsObjCModel : NSObject <JavaScriptObjectiveCDelegate>
	
	@property (nonatomic, weak) JSContext *jsContext;
	
	@property (nonatomic, weak) UIWebView *webView;
	
	@end
	
3. å®ç°ç»‘å®š

	   
	    NLJsObjCModel *model  = [[NLJsObjCModel alloc] init];
	    
	    self.jsContext[@"OCModel"] = model;
	    
	    model.jsContext = self.jsContext;
	    
	    model.webView = self.webView;
	
JavaScriptCoreæ¡†æ¶ä½¿ç”¨è¿™éƒ¨åˆ†ä»£ç æ¥æºäº[IOS åŸç”Ÿä¸HTMLäº¤äº’](http://blog.csdn.net/ioschenlu/article/details/51942349)   
 
** ç¬¬äºŒéƒ¨åˆ†ï¼šåŸç”Ÿ->H5
**

è·å–JSContextå¯¹è±¡ï¼Œå¯¹è±¡è°ƒç”¨evaluateScriptï¼šè·å–JSValuedå¯¹è±¡ï¼Œæœ€ç»ˆå®ç°ä¸JSçš„äº¤äº’ã€‚

	- (void)webViewDidFinishLoad:(UIWebView *)webView {
	    JSContext *jsContext = [webView     valueForKeyPath:@"documentView.webView.mainFrame.javaScriptContext"];
	    JSValue *jsValue = [jsContext evaluateScript:@"showAppAlertMsg"];
	    [jsValue callWithArguments:@[@"è¿™æ˜¯appæœ¬åœ°äº¤äº’æ–‡æ¡ˆ"]];
	}

### æ€»ç»“
è¿™äº›æ–¹æ³•éƒ½å¯ä»¥å®ç°äº¤äº’ï¼ŒUIWebViewéœ€è¦æŒ‡å®šåè®®ï¼Œå¤„ç†æ›´å¤šç»†èŠ‚ï¼›WKWebViewå’ŒWebViewJavascriptBridgeçš„ä½¿ç”¨æ¨¡å¼å¾ˆåƒï¼Œå¯ä»¥çœ‹å‡ºç›¸æ¯”äºUIWebViewçš„äº¤äº’æµç¨‹å·²ç»ç®€æ´å¾ˆå¤šï¼›WebViewJavascriptBridgeæä¾›äº†å¯¹UIWebViewå’ŒWKWebViewçš„æ”¯æŒï¼Œè€Œä¸”å’ŒJSçš„äº¤äº’è¿‡ç¨‹å¾ˆç®€æ´ã€‚JavaScriptCoreæ˜¯å®ç°äº†é¢å‘åè®®çš„å°è£…ï¼Œçœ‹èµ·æ¥ç¨å¾®å¤æ‚ï¼Œä½†æ˜¯ä»£ç çš„å°è£…æ€§ä¼šæ›´å¥½ã€‚

å¾ˆå¤šå…¬å¸çš„è€ä»£ç è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ä½¿ç”¨UIWebViewçš„è‡ªå®šä¹‰åè®®æ‹¦æˆªçš„æ–¹æ³•ï¼Œæ‰€ä»¥è¿™æ–¹é¢çš„ä½¿ç”¨éœ€è¦äº†è§£ï¼›å¯¹äºæ–°çš„ä»£ç ï¼Œè¿˜æ˜¯å¸Œæœ›å¯ä»¥é‡‡ç”¨JavaScriptCoreæˆ–è€…WebViewJavascriptBridge ç»“åˆWKWebViewçš„æ–¹å¼ã€‚

